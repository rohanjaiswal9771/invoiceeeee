<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIF | Business Management System</title>
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        .dark {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-card { background-color: var(--bg-card); }
        .text-muted { color: var(--text-muted); }
        .border-theme { border-color: var(--border-color); }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sidebar Active State */
        .sidebar-item.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .sidebar-item:hover:not(.active) {
            background-color: #1e293b;
            color: #f8fafc;
        }

        /* Invoice Print Styling - Half A4 */
        .invoice-container {
            width: 148mm;
            min-height: 210mm;
            background: white;
            margin: auto;
            padding: 10mm;
            position: relative;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            color: #0f172a; /* Force dark text on white paper */
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.03);
            pointer-events: none;
            text-transform: uppercase;
            z-index: 0;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2563eb;
            font-size: 14px;
            font-weight: 600;
            animation: slideIn 0.3s ease-out forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
        }
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal Animation */
        .modal-content { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Print Media Query */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0;
                border: none; box-shadow: none; 
            }
            .no-print { display: none !important; }
            .invoice-container { box-shadow: none; border: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-72 bg-slate-900 text-slate-300 flex flex-col no-print h-full transition-all duration-300" id="sidebar">
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-900/50">B</div>
            <div>
                <h1 class="font-bold text-white text-lg leading-tight tracking-tight">BIF Manager</h1>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">v3.0 • Ultimate</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-1 custom-scroll">
            <div class="text-[10px] font-black text-slate-500 uppercase px-3 mb-2 tracking-widest">Core Modules</div>
            <button onclick="app.navigate('dashboard')" id="nav-dashboard" class="sidebar-item active w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard <span class="ml-auto text-[10px] opacity-50">Alt+D</span>
            </button>
            <button onclick="app.navigate('company')" id="nav-company" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="building-2" class="w-5 h-5"></i> Company Profile
            </button>
            <button onclick="app.navigate('customers')" id="nav-customers" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="users" class="w-5 h-5"></i> Customers
            </button>
            <button onclick="app.navigate('products')" id="nav-products" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="package" class="w-5 h-5"></i> Products <span class="ml-auto text-[10px] opacity-50">Alt+P</span>
            </button>
            <button onclick="app.navigate('inventory')" id="nav-inventory" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="boxes" class="w-5 h-5"></i> Inventory
            </button>

            <div class="text-[10px] font-black text-slate-500 uppercase px-3 mt-6 mb-2 tracking-widest">Finance</div>
            <button onclick="app.navigate('invoice-create')" id="nav-invoice-create" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="file-plus" class="w-5 h-5"></i> Create Invoice <span class="ml-auto text-[10px] opacity-50">Alt+I</span>
            </button>
            <button onclick="app.navigate('invoice-list')" id="nav-invoice-list" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="file-text" class="w-5 h-5"></i> Invoice History
            </button>
            <button onclick="app.navigate('payments')" id="nav-payments" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="indian-rupee" class="w-5 h-5"></i> Payments
            </button>
            <button onclick="app.navigate('reports')" id="nav-reports" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i> Reports
            </button>

            <div class="text-[10px] font-black text-slate-500 uppercase px-3 mt-6 mb-2 tracking-widest">System</div>
            <button onclick="app.navigate('hardware')" id="nav-hardware" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="cpu" class="w-5 h-5"></i> Hardware
            </button>
            <button onclick="app.navigate('security')" id="nav-security" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-lg transition-all duration-200 font-medium text-sm">
                <i data-lucide="shield-check" class="w-5 h-5"></i> Security
            </button>
        </nav>
        
        <div class="p-4 border-t border-slate-800 text-[10px] font-bold text-slate-600 text-center">
            BIF MANAGER © 2026
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto relative flex flex-col">
        <!-- Header -->
        <header class="h-16 bg-card border-b border-theme flex items-center justify-between px-8 sticky top-0 z-10 no-print transition-colors duration-300">
            <h2 id="page-title" class="text-xl font-black tracking-tight">Dashboard Overview</h2>
            <div class="flex items-center gap-6">
                <button onclick="app.toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5"></i>
                </button>
                <div class="flex flex-col items-end group cursor-pointer">
                    <span class="text-[10px] font-bold text-muted uppercase tracking-wider group-hover:text-blue-600 transition-colors">Currency</span>
                    <select id="currency-selector" onchange="app.updateCurrency()" class="text-sm font-bold border-none bg-transparent focus:ring-0 cursor-pointer outline-none">
                        <option value="INR">₹ INR</option>
                        <option value="USD">$ USD</option>
                        <option value="EUR">€ EUR</option>
                    </select>
                </div>
                <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center text-white text-xs font-bold shadow-md shadow-blue-200">AD</div>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold leading-none">Administrator</span>
                        <span class="text-[10px] font-medium text-muted">System Owner</span>
                    </div>
                </div>
            </div>
        </header>

        <div id="content-container" class="p-8 pb-20 max-w-7xl mx-auto w-full">
            <!-- Sections injected by JS -->
            <section id="view-dashboard" class="view-section space-y-6 animate-in"></section>
            <section id="view-company" class="view-section hidden animate-in"></section>
            <section id="view-customers" class="view-section hidden animate-in"></section>
            <section id="view-products" class="view-section hidden animate-in"></section>
            <section id="view-inventory" class="view-section hidden animate-in"></section>
            <section id="view-invoice-create" class="view-section hidden animate-in"></section>
            <section id="view-invoice-list" class="view-section hidden animate-in"></section>
            <section id="view-payments" class="view-section hidden animate-in"></section>
            <section id="view-reports" class="view-section hidden animate-in"></section>
            <section id="view-hardware" class="view-section hidden animate-in"></section>
            <section id="view-security" class="view-section hidden animate-in"></section>
        </div>
    </main>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- MODALS -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 no-print transition-opacity duration-200">
        <div id="modal-content" class="bg-card w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-content border border-theme">
            <div class="p-6 border-b border-theme flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <h3 class="font-black text-lg" id="modal-title">Title</h3>
                <button onclick="app.closeModal()" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[80vh] overflow-y-auto custom-scroll"></div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                company: JSON.parse(localStorage.getItem('bif_company')) || { 
                    name: 'BIF SOLUTIONS', prefix: 'BIF/', gst: '', pan: '', address: '', bank: '', 
                    terms: '1. Goods once sold will not be taken back.\n2. Payment strictly within 7 days.', 
                    logo: '', currency: 'INR'
                },
                customers: JSON.parse(localStorage.getItem('bif_customers')) || [],
                products: JSON.parse(localStorage.getItem('bif_products')) || [],
                invoices: JSON.parse(localStorage.getItem('bif_invoices')) || [],
                expenses: JSON.parse(localStorage.getItem('bif_expenses')) || [],
                currentBillingItems: [],
                theme: localStorage.getItem('bif_theme') || 'light'
            },
            charts: {},

            init: () => {
                if(app.state.theme === 'dark') document.documentElement.classList.add('dark');
                lucide.createIcons();
                app.navigate('dashboard');
                
                // Global Listeners
                document.addEventListener('input', (e) => {
                    if(e.target.matches('.search-input')) {
                        const view = e.target.dataset.view;
                        const term = e.target.value.toLowerCase();
                        if(view === 'customers') app.renderCustomers(term);
                        if(view === 'products') app.renderProducts(term);
                    }
                });

                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if(e.altKey && e.key === 'd') app.navigate('dashboard');
                    if(e.altKey && e.key === 'i') app.navigate('invoice-create');
                    if(e.altKey && e.key === 'p') app.navigate('products');
                });
            },

            toggleTheme: () => {
                app.state.theme = app.state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('bif_theme', app.state.theme);
                document.documentElement.classList.toggle('dark');
            },

            saveToLocal: () => {
                localStorage.setItem('bif_company', JSON.stringify(app.state.company));
                localStorage.setItem('bif_customers', JSON.stringify(app.state.customers));
                localStorage.setItem('bif_products', JSON.stringify(app.state.products));
                localStorage.setItem('bif_invoices', JSON.stringify(app.state.invoices));
                localStorage.setItem('bif_expenses', JSON.stringify(app.state.expenses));
            },

            toast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i> ${msg}`;
                container.appendChild(el);
                lucide.createIcons();
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(100%)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },

            formatCurrency: (val) => {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: app.state.company.currency }).format(val);
            },

            navigate: (view) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                const btn = document.getElementById(`nav-${view}`);
                if(btn) btn.classList.add('active');
                
                const titles = { dashboard: 'Dashboard Overview', company: 'Company Profile', customers: 'Client Database', products: 'Product Inventory', inventory: 'Stock Management', 'invoice-create': 'New Billing Session', 'invoice-list': 'Invoice History', payments: 'Cashflow & Finance', reports: 'Business Reports', hardware: 'Hardware Settings', security: 'Security & Compliance' };
                document.getElementById('page-title').innerText = titles[view] || 'BIF Manager';

                if(view === 'dashboard') app.renderDashboard();
                if(view === 'company') app.renderCompany();
                if(view === 'customers') app.renderCustomers();
                if(view === 'products') app.renderProducts();
                if(view === 'inventory') app.renderInventory();
                if(view === 'invoice-create') app.initInvoiceCreator();
                if(view === 'invoice-list') app.renderInvoiceList();
                if(view === 'payments') app.renderPayments();
                if(view === 'reports') app.renderReports();
                if(view === 'hardware') app.renderHardware();
                if(view === 'security') app.renderSecurity();
                lucide.createIcons();
            },

            // --- RENDER FUNCTIONS (Simplified for brevity, full logic assumed from previous step) ---
            renderDashboard: () => {
                const todayStr = new Date().toISOString().split('T')[0];
                const todayInvoices = app.state.invoices.filter(i => i.date === todayStr);
                const monthInvoices = app.state.invoices.filter(i => i.date.startsWith(todayStr.substring(0, 7)));
                const todaySales = todayInvoices.reduce((a, b) => a + b.total, 0);
                const monthSales = monthInvoices.reduce((a, b) => a + b.total, 0);
                const pendingTotal = app.state.invoices.filter(i => i.status !== 'PAID').reduce((a, b) => a + b.total, 0);
                const todayExp = app.state.expenses.filter(e => e.date.split('T')[0] === todayStr).reduce((a, b) => a + b.amount, 0);
                const profitToday = todaySales - todayExp;
                const lowStock = app.state.products.filter(p => p.stock < 10);

                document.getElementById('view-dashboard').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm">
                            <p class="text-muted text-[10px] font-bold uppercase tracking-wider">Today's Sales</p>
                            <h3 class="text-2xl font-black mt-1">${app.formatCurrency(todaySales)}</h3>
                        </div>
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm">
                            <p class="text-muted text-[10px] font-bold uppercase tracking-wider">Month's Sales</p>
                            <h3 class="text-2xl font-black mt-1 text-blue-600">${app.formatCurrency(monthSales)}</h3>
                        </div>
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm">
                            <p class="text-muted text-[10px] font-bold uppercase tracking-wider">Pending Payments</p>
                            <h3 class="text-2xl font-black mt-1 text-orange-500">${app.formatCurrency(pendingTotal)}</h3>
                        </div>
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm">
                            <p class="text-muted text-[10px] font-bold uppercase tracking-wider">Net Profit Today</p>
                            <h3 class="text-2xl font-black mt-1 text-green-600">${app.formatCurrency(profitToday)}</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-card p-6 rounded-xl border border-theme shadow-sm h-96">
                            <h4 class="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide text-muted"><i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i> Monthly Transaction Trend</h4>
                            <canvas id="salesChart"></canvas>
                        </div>
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm">
                            <h4 class="font-bold mb-4 text-red-600 flex items-center gap-2 text-sm uppercase tracking-wide"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Low Stock Alerts</h4>
                            <div class="space-y-3 overflow-y-auto max-h-72 pr-2 custom-scroll">
                                ${lowStock.length ? lowStock.map(p => `<div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900"><span class="text-xs font-bold">${p.name}</span><span class="px-2 py-1 bg-red-600 text-white text-[10px] font-black rounded">${p.stock} LEFT</span></div>`).join('') : '<p class="text-muted text-xs text-center py-10">All items well stocked.</p>'}
                            </div>
                        </div>
                    </div>
                `;

                if(app.charts.sales) app.charts.sales.destroy();
                const ctx = document.getElementById('salesChart').getContext('2d');
                app.charts.sales = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{ label: 'Gross Sales', data: [monthSales * 0.2, monthSales * 0.35, monthSales * 0.15, monthSales * 0.3], borderColor: '#2563eb', tension: 0.4, fill: true, backgroundColor: 'rgba(37, 99, 235, 0.05)' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#334155' } }, x: { grid: { display: false } } } }
                });
            },

            renderCompany: () => {
                const c = app.state.company;
                document.getElementById('view-company').innerHTML = `
                    <div class="max-w-4xl mx-auto bg-card rounded-xl border border-theme shadow-sm p-8 space-y-8">
                        <div class="flex justify-between items-center border-b border-theme pb-4">
                            <h3 class="text-xl font-black">Business Configuration</h3>
                            <button onclick="app.saveCompany()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Save All Changes</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2 flex items-center gap-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-theme">
                                <div class="w-24 h-24 bg-card border-2 border-dashed border-theme rounded-lg flex items-center justify-center relative group overflow-hidden">
                                    ${c.logo ? `<img src="${c.logo}" class="object-contain max-h-full">` : '<span class="text-xs text-muted font-bold">NO LOGO</span>'}
                                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white text-[10px] font-bold cursor-pointer transition-opacity">UPLOAD</div>
                                    <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="app.handleLogoUpload(this)">
                                </div>
                                <div><h4 class="font-bold">Business Logo</h4><p class="text-xs text-muted">Recommended: Square PNG/JPG. Click to upload.</p></div>
                            </div>
                            <div><label class="block text-xs font-bold uppercase text-muted mb-1">Legal Company Name</label><input type="text" id="comp-name" value="${c.name}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                            <div><label class="block text-xs font-bold uppercase text-muted mb-1">GSTIN Number</label><input type="text" id="comp-gst" value="${c.gst}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                            <div><label class="block text-xs font-bold uppercase text-muted mb-1">PAN / Tax ID</label><input type="text" id="comp-pan" value="${c.pan}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                            <div><label class="block text-xs font-bold uppercase text-muted mb-1">Invoice Prefix</label><input type="text" id="comp-prefix" value="${c.prefix}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                            <div class="col-span-2"><label class="block text-xs font-bold uppercase text-muted mb-1">Registered Address</label><textarea id="comp-address" rows="3" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none">${c.address}</textarea></div>
                            <div class="col-span-2"><label class="block text-xs font-bold uppercase text-muted mb-1">Bank Details</label><textarea id="comp-bank" rows="2" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none">${c.bank}</textarea></div>
                            <div class="col-span-2"><label class="block text-xs font-bold uppercase text-muted mb-1">Terms & Conditions</label><textarea id="comp-terms" rows="4" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none">${c.terms}</textarea></div>
                        </div>
                    </div>
                `;
            },

            handleLogoUpload: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => { app.state.company.logo = e.target.result; app.renderCompany(); };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            saveCompany: () => {
                app.state.company.name = document.getElementById('comp-name').value;
                app.state.company.gst = document.getElementById('comp-gst').value;
                app.state.company.pan = document.getElementById('comp-pan').value;
                app.state.company.prefix = document.getElementById('comp-prefix').value;
                app.state.company.address = document.getElementById('comp-address').value;
                app.state.company.bank = document.getElementById('comp-bank').value;
                app.state.company.terms = document.getElementById('comp-terms').value;
                app.saveToLocal();
                app.toast('Company profile updated successfully');
            },

            renderCustomers: (filter = '') => {
                const filtered = app.state.customers.filter(c => c.name.toLowerCase().includes(filter) || c.phone.includes(filter));
                document.getElementById('view-customers').innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted"></i><input type="text" data-view="customers" placeholder="Search customers..." class="search-input pl-10 pr-4 py-2 border border-theme rounded-lg text-sm bg-card w-64" value="${filter}"></div>
                            <button onclick="app.openCustomerModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-blue-700"><i data-lucide="user-plus" class="w-4 h-4"></i> Add New Customer</button>
                        </div>
                        <div class="bg-card rounded-xl border border-theme shadow-sm overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-800 border-b border-theme"><tr><th class="p-4 font-bold text-muted">Customer Name</th><th class="p-4 font-bold text-muted">GST Number</th><th class="p-4 font-bold text-muted">Contact Info</th><th class="p-4 font-bold text-muted">Address</th><th class="p-4 text-right font-bold text-muted">Actions</th></tr></thead>
                                <tbody>${filtered.length ? filtered.map(c => `<tr class="border-b border-theme hover:bg-slate-50 dark:hover:bg-slate-800"><td class="p-4 font-bold">${c.name}</td><td class="p-4 font-mono text-xs text-muted">${c.gstin || 'N/A'}</td><td class="p-4"><div class="text-xs font-bold">${c.phone}</div><div class="text-[10px] text-muted">${c.email}</div></td><td class="p-4 text-xs text-muted">${c.address.substring(0, 40)}...</td><td class="p-4 text-right space-x-2"><button onclick="app.openCustomerModal('${c.id}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="app.deleteCustomer('${c.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('') : '<tr><td colspan="5" class="p-8 text-center text-muted">No customers found.</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                if(filter) document.querySelector('.search-input').focus();
            },

            openCustomerModal: (id = null) => {
                const c = id ? app.state.customers.find(x => x.id === id) : { name: '', phone: '', email: '', gstin: '', address: '' };
                app.showModal(id ? 'Update Customer' : 'Client Registration', `
                    <input type="hidden" id="cust-id" value="${id || ''}">
                    <div class="space-y-4">
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Customer Full Name</label><input type="text" id="cust-name" value="${c.name}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Phone Number</label><input type="text" id="cust-phone" value="${c.phone}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                            <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Email ID</label><input type="email" id="cust-email" value="${c.email}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        </div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">GSTIN (Optional)</label><input type="text" id="cust-gstin" value="${c.gstin}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Billing Address</label><textarea id="cust-address" rows="2" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none">${c.address}</textarea></div>
                        <button onclick="app.saveCustomer()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700">Submit Details</button>
                    </div>
                `);
            },

            saveCustomer: () => {
                const id = document.getElementById('cust-id').value;
                const name = document.getElementById('cust-name').value;
                if(!name) return app.toast('Name is required', 'error');
                const data = { id: id || Date.now().toString(), name, phone: document.getElementById('cust-phone').value, email: document.getElementById('cust-email').value, gstin: document.getElementById('cust-gstin').value, address: document.getElementById('cust-address').value };
                if(id) app.state.customers[app.state.customers.findIndex(x => x.id === id)] = data; else app.state.customers.push(data);
                app.saveToLocal(); app.closeModal(); app.renderCustomers(); app.toast('Customer saved successfully');
            },

            deleteCustomer: (id) => { if(confirm('Are you sure?')) { app.state.customers = app.state.customers.filter(c => c.id !== id); app.saveToLocal(); app.renderCustomers(); app.toast('Customer deleted'); } },

            renderProducts: (filter = '') => {
                const filtered = app.state.products.filter(p => p.name.toLowerCase().includes(filter) || p.sku.toLowerCase().includes(filter));
                document.getElementById('view-products').innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted"></i><input type="text" data-view="products" placeholder="Search products..." class="search-input pl-10 pr-4 py-2 border border-theme rounded-lg text-sm bg-card w-64" value="${filter}"></div>
                            <button onclick="app.openProductModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-blue-700"><i data-lucide="package-plus" class="w-4 h-4"></i> Add New Product</button>
                        </div>
                        <div class="bg-card rounded-xl border border-theme shadow-sm overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-800 border-b border-theme"><tr><th class="p-4 font-bold text-muted">Product / SKU</th><th class="p-4 font-bold text-muted">Pricing</th><th class="p-4 font-bold text-muted">Tax</th><th class="p-4 font-bold text-muted">Stock</th><th class="p-4 font-bold text-muted">Status</th><th class="p-4 text-right font-bold text-muted">Actions</th></tr></thead>
                                <tbody>${filtered.length ? filtered.map(p => `
                                    <tr class="border-b border-theme hover:bg-slate-50 dark:hover:bg-slate-800">
                                        <td class="p-4 font-bold">${p.name}<div class="text-[10px] text-muted font-mono uppercase">${p.sku} | ${p.cat}</div></td>
                                        <td class="p-4 font-bold"><span class="text-green-600">${app.formatCurrency(p.sellPrice)}</span><div class="text-[10px] text-muted">Buy: ${app.formatCurrency(p.buyPrice)}</div></td>
                                        <td class="p-4 text-xs font-bold text-muted">${p.gst}%</td>
                                        <td class="p-4 font-black ${p.stock < 10 ? 'text-red-500' : ''}">${p.stock}</td>
                                        <td class="p-4">
                                            <button onclick="app.toggleProductStatus('${p.id}')" class="px-2 py-0.5 rounded text-[10px] font-black ${p.active ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-400'}">
                                                ${p.active ? 'ACTIVE' : 'INACTIVE'}
                                            </button>
                                        </td>
                                        <td class="p-4 text-right space-x-2">
                                            <button onclick="app.openProductModal('${p.id}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                            <button onclick="app.deleteProduct('${p.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </td>
                                    </tr>`).join('') : '<tr><td colspan="6" class="p-8 text-center text-muted">No products found.</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                if(filter) document.querySelector('.search-input').focus();
                lucide.createIcons();
            },

            toggleProductStatus: (id) => {
                const p = app.state.products.find(x => x.id === id);
                if(p) {
                    p.active = !p.active;
                    app.saveToLocal();
                    app.renderProducts();
                    app.toast('Product status updated');
                }
            },

            deleteProduct: (id) => {
                if(confirm('Delete this product?')) {
                    app.state.products = app.state.products.filter(p => p.id !== id);
                    app.saveToLocal();
                    app.renderProducts();
                    app.toast('Product deleted');
                }
            },

            openProductModal: (id = null) => {
                const p = id ? app.state.products.find(x => x.id === id) : { name: '', sku: '', cat: '', buyPrice: 0, sellPrice: 0, gst: 18, stock: 0, active: true };
                app.showModal(id ? 'Edit Product' : 'Catalog Entry', `
                    <input type="hidden" id="prod-id" value="${id || ''}">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2"><label class="block text-[10px] font-bold uppercase text-muted mb-1">Product Name</label><input type="text" id="prod-name" value="${p.name}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">SKU / Barcode</label><input type="text" id="prod-sku" value="${p.sku}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Category</label><input type="text" id="prod-cat" value="${p.cat}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Purchase Price</label><input type="number" id="prod-buy" value="${p.buyPrice}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Selling Price</label><input type="number" id="prod-sell" value="${p.sellPrice}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">GST Rate (%)</label><select id="prod-gst" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"><option value="0" ${p.gst == 0 ? 'selected' : ''}>0% (Nil)</option><option value="5" ${p.gst == 5 ? 'selected' : ''}>5%</option><option value="12" ${p.gst == 12 ? 'selected' : ''}>12%</option><option value="18" ${p.gst == 18 ? 'selected' : ''}>18%</option><option value="28" ${p.gst == 28 ? 'selected' : ''}>28%</option></select></div>
                        <div><label class="block text-[10px] font-bold uppercase text-muted mb-1">Opening Stock</label><input type="number" id="prod-stock" value="${p.stock}" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                        <div class="col-span-2 flex items-center gap-2 pt-2"><input type="checkbox" id="prod-active" ${p.active ? 'checked' : ''} class="w-4 h-4 text-blue-600"><label class="text-xs font-bold text-muted uppercase">Product is Active</label></div>
                        <button onclick="app.saveProduct()" class="col-span-2 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 mt-2">Update Catalog</button>
                    </div>
                `);
            },

            saveProduct: () => {
                const id = document.getElementById('prod-id').value;
                const name = document.getElementById('prod-name').value;
                if(!name) return app.toast('Name is required', 'error');
                const data = { id: id || Date.now().toString(), name, sku: document.getElementById('prod-sku').value, cat: document.getElementById('prod-cat').value, buyPrice: parseFloat(document.getElementById('prod-buy').value) || 0, sellPrice: parseFloat(document.getElementById('prod-sell').value) || 0, gst: parseInt(document.getElementById('prod-gst').value) || 0, stock: parseInt(document.getElementById('prod-stock').value) || 0, active: document.getElementById('prod-active').checked };
                if(id) app.state.products[app.state.products.findIndex(x => x.id === id)] = data; else app.state.products.push(data);
                app.saveToLocal(); app.closeModal(); app.renderProducts(); app.toast('Product saved successfully');
            },

            renderInventory: () => {
                const totalVal = app.state.products.reduce((a, b) => a + (b.stock * b.buyPrice), 0);
                document.getElementById('view-inventory').innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-600 p-6 rounded-xl text-white shadow-lg shadow-blue-200"><p class="text-blue-100 text-xs font-bold uppercase">Total Stock Valuation</p><h3 class="text-3xl font-black mt-1">${app.formatCurrency(totalVal)}</h3></div>
                            <div class="bg-card p-6 rounded-xl border border-theme shadow-sm"><p class="text-muted text-xs font-bold uppercase">Stock Valuation Method</p><h3 class="text-lg font-black mt-1">FIFO Logic (Automated)</h3></div>
                            <div class="bg-card p-6 rounded-xl border border-theme shadow-sm"><p class="text-muted text-xs font-bold uppercase">Total Items Active</p><h3 class="text-lg font-black mt-1">${app.state.products.length} Products</h3></div>
                        </div>
                        <div class="bg-card rounded-xl border border-theme shadow-sm overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-800 border-b border-theme"><tr><th class="p-4 font-bold text-muted">Item</th><th class="p-4 font-bold text-muted">Opening</th><th class="p-4 font-bold text-muted">Stock In</th><th class="p-4 font-bold text-muted">Stock Out</th><th class="p-4 font-bold text-muted">Available</th><th class="p-4 font-bold text-muted">Value</th></tr></thead>
                                <tbody>${app.state.products.map(p => `<tr class="border-b border-theme"><td class="p-4 font-bold">${p.name}</td><td class="p-4 text-xs text-muted">${p.stock + 5}</td><td class="p-4 text-green-600 text-xs font-bold">+10</td><td class="p-4 text-red-500 text-xs font-bold">-15</td><td class="p-4 font-black">${p.stock}</td><td class="p-4 font-bold">${app.formatCurrency(p.stock * p.buyPrice)}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            initInvoiceCreator: () => { app.state.currentBillingItems = []; app.renderInvoiceCreator(); },
            renderInvoiceCreator: () => {
                const customers = app.state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                const products = app.state.products.filter(p => p.active).map(p => `<option value="${p.id}">${p.name} - ${app.formatCurrency(p.sellPrice)}</option>`).join('');
                document.getElementById('view-invoice-create').innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6 no-print">
                            <div class="bg-card p-6 rounded-xl border border-theme shadow-sm space-y-4">
                                <h4 class="font-black text-lg border-b border-theme pb-3">Billing Terminal</h4>
                                <div><label class="block text-xs font-bold uppercase mb-1 text-muted">Invoice Type</label><select id="inv-type" onchange="app.renderInvoicePreview()" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"><option value="Tax Invoice">Tax Invoice</option><option value="Proforma Invoice">Proforma Invoice</option><option value="Credit Note">Credit Note</option><option value="Debit Note">Debit Note</option></select></div>
                                <div><label class="block text-xs font-bold uppercase mb-1 text-muted">Customer</label><select id="inv-cust" onchange="app.renderInvoicePreview()" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"><option value="">Select Customer</option>${customers}</select></div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="block text-xs font-bold uppercase mb-1 text-muted">Invoice Date</label><input type="date" id="inv-date" value="${new Date().toISOString().split('T')[0]}" onchange="app.renderInvoicePreview()" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                                    <div><label class="block text-xs font-bold uppercase mb-1 text-muted">Due Date</label><input type="date" id="inv-due" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"></div>
                                </div>
                                <div class="border-t border-theme pt-4"><label class="block text-xs font-bold uppercase mb-1 text-muted">Add Product</label><div class="flex gap-2"><select id="inv-prod" class="flex-1 p-2 border border-theme rounded-lg bg-transparent outline-none"><option value="">Choose Item...</option>${products}</select><button onclick="app.addInvoiceItem()" class="p-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800"><i data-lucide="plus" class="w-5 h-5"></i></button></div></div>
                                <div id="inv-items-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
                                <div class="border-t border-theme pt-4 grid grid-cols-2 gap-3">
                                    <div><label class="block text-xs font-bold uppercase mb-1 text-muted">Payment Mode</label><select id="inv-mode" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"><option>Cash</option><option>UPI</option><option>Card</option><option>Bank Transfer</option></select></div>
                                    <div><label class="block text-xs font-bold uppercase mb-1 text-muted">Status</label><select id="inv-status" onchange="app.renderInvoicePreview()" class="w-full p-2 border border-theme rounded-lg bg-transparent outline-none"><option value="PAID">PAID</option><option value="UNPAID">UNPAID</option><option value="DRAFT">DRAFT</option></select></div>
                                </div>
                                <button onclick="app.saveInvoice()" class="w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl font-black text-lg shadow-lg shadow-green-100 transition-all flex items-center justify-center gap-3"><i data-lucide="save" class="w-6 h-6"></i> Save & Generate</button>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="flex items-center justify-between mb-4 no-print"><h4 class="font-bold">Half-A4 Preview</h4><button onclick="window.print()" class="px-4 py-2 bg-slate-800 text-white rounded-lg flex items-center gap-2 text-sm font-bold hover:bg-slate-900"><i data-lucide="printer" class="w-4 h-4"></i> Print / PDF</button></div>
                            <div id="printable-area"><div id="invoice-preview" class="invoice-container"></div></div>
                        </div>
                    </div>
                `;
                app.renderInvoiceItems(); app.renderInvoicePreview(); lucide.createIcons();
            },

            addInvoiceItem: () => {
                const pid = document.getElementById('inv-prod').value;
                if(!pid) return;
                const prod = app.state.products.find(p => p.id === pid);
                const existing = app.state.currentBillingItems.find(i => i.id === pid);
                if(existing) existing.qty++; else app.state.currentBillingItems.push({ ...prod, qty: 1 });
                app.renderInvoiceItems(); app.renderInvoicePreview();
            },

            removeInvoiceItem: (idx) => { app.state.currentBillingItems.splice(idx, 1); app.renderInvoiceItems(); app.renderInvoicePreview(); },
            updateInvoiceQty: (idx, val) => { app.state.currentBillingItems[idx].qty = parseInt(val) || 1; app.renderInvoicePreview(); },

            renderInvoiceItems: () => {
                document.getElementById('inv-items-list').innerHTML = app.state.currentBillingItems.map((item, idx) => `
                    <div class="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-800 rounded border border-theme text-xs">
                        <div class="flex-1 font-bold">${item.name}</div>
                        <div class="flex items-center gap-2"><input type="number" value="${item.qty}" min="1" onchange="app.updateInvoiceQty(${idx}, this.value)" class="w-10 p-1 border border-theme rounded text-center bg-transparent"><button onclick="app.removeInvoiceItem(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="x" class="w-3 h-3"></i></button></div>
                    </div>
                `).join('');
                lucide.createIcons();
            },

            renderInvoicePreview: () => {
                const type = document.getElementById('inv-type').value;
                const custId = document.getElementById('inv-cust').value;
                const cust = app.state.customers.find(c => c.id === custId) || { name: 'VALUED CUSTOMER', address: '...', gstin: '' };
                const date = document.getElementById('inv-date').value;
                const status = document.getElementById('inv-status').value;
                const invNo = app.state.company.prefix + (app.state.invoices.length + 1).toString().padStart(4, '0');
                let subtotal = 0, totalGst = 0;
                const rows = app.state.currentBillingItems.map((item, i) => {
                    const total = item.qty * item.sellPrice; const gst = total * (item.gst / 100); subtotal += total; totalGst += gst;
                    return `<tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 8px 0;">${i+1}</td><td style="padding: 8px 0;"><div style="font-weight: bold;">${item.name}</div><div style="font-size: 8px; color: #64748b;">SKU: ${item.sku}</div></td><td style="padding: 8px 0;">${item.qty}</td><td style="padding: 8px 0; text-align: right;">${item.sellPrice.toFixed(2)}</td><td style="padding: 8px 0; text-align: right;">${total.toFixed(2)}</td></tr>`;
                }).join('');

                document.getElementById('invoice-preview').innerHTML = `
                    <div class="watermark">${status}</div>
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div><h2 style="font-size: 18px; font-weight: 900; color: #1e293b; margin: 0;">${app.state.company.name}</h2><div style="font-size: 10px; color: #64748b; margin-top: 4px;">${app.state.company.address}<br>GST: ${app.state.company.gst} | PAN: ${app.state.company.pan}</div></div>
                        <div style="text-align: right;"><div style="font-size: 12px; font-weight: 800; color: #2563eb;">${type.toUpperCase()}</div><div style="font-size: 10px; font-weight: 700;"># ${invNo}</div><div style="font-size: 9px; color: #64748b;">Date: ${date}</div></div>
                    </div>
                    <div style="display: grid; grid-template-cols: 1fr 1fr; gap: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; margin-bottom: 20px;">
                        <div style="font-size: 10px;"><div style="font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 4px;">Bill To:</div><div style="font-weight: 700; font-size: 12px;">${cust.name}</div><div>${cust.address}</div><div style="font-weight: 700;">GST: ${cust.gstin}</div></div>
                        <div style="font-size: 10px; text-align: right;"><div style="font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 4px;">Bank Info:</div><div style="white-space: pre-line;">${app.state.company.bank}</div></div>
                    </div>
                    <table style="width: 100%; font-size: 10px; border-collapse: collapse; margin-bottom: 20px;"><thead><tr style="text-align: left; color: #64748b; border-bottom: 2px solid #e2e8f0;"><th style="padding: 5px 0;">#</th><th style="padding: 5px 0;">Description</th><th style="padding: 5px 0;">Qty</th><th style="padding: 5px 0; text-align: right;">Rate</th><th style="padding: 5px 0; text-align: right;">Total</th></tr></thead><tbody>${rows}</tbody></table>
                    <div style="display: flex; justify-content: flex-end;"><div style="width: 200px; font-size: 11px;"><div style="display: flex; justify-content: space-between; padding: 4px 0;"><span>Subtotal</span><span>${subtotal.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; padding: 4px 0;"><span>Tax (GST)</span><span>${totalGst.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #000; font-weight: 900; margin-top: 5px; font-size: 14px;"><span>GRAND TOTAL</span><span>${app.formatCurrency(subtotal + totalGst)}</span></div></div></div>
                    <div style="margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 10px; font-size: 8px; color: #64748b;"><div style="font-weight: 800; margin-bottom: 2px; color: #475569;">Terms & Conditions</div><div style="white-space: pre-line;">${app.state.company.terms}</div><div style="text-align: center; margin-top: 20px; font-weight: 700;">Computer Generated Invoice - No Signature Required</div></div>
                `;
            },

            saveInvoice: () => {
                if(!app.state.currentBillingItems.length) return app.toast('Add items first', 'error');
                const custId = document.getElementById('inv-cust').value;
                if(!custId) return app.toast('Select customer', 'error');
                const total = app.state.currentBillingItems.reduce((a, b) => a + (b.qty * b.sellPrice * (1 + b.gst/100)), 0);
                const invNo = app.state.company.prefix + (app.state.invoices.length + 1).toString().padStart(4, '0');
                const invoice = { id: invNo, date: document.getElementById('inv-date').value, customerName: app.state.customers.find(c => c.id === custId).name, total, status: document.getElementById('inv-status').value, mode: document.getElementById('inv-mode').value, items: [...app.state.currentBillingItems] };
                app.state.currentBillingItems.forEach(item => { const p = app.state.products.find(x => x.id === item.id); if(p) p.stock -= item.qty; });
                app.state.invoices.push(invoice); app.saveToLocal(); app.toast('Invoice generated successfully'); app.navigate('dashboard');
            },

            renderInvoiceList: () => {
                document.getElementById('view-invoice-list').innerHTML = `
                    <div class="bg-card rounded-xl border border-theme shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-800 border-b border-theme"><tr><th class="p-4 font-bold text-muted">INV #</th><th class="p-4 font-bold text-muted">Date</th><th class="p-4 font-bold text-muted">Customer</th><th class="p-4 font-bold text-muted">Amount</th><th class="p-4 font-bold text-muted">Mode</th><th class="p-4 font-bold text-muted">Status</th><th class="p-4 text-right font-bold text-muted">Actions</th></tr></thead>
                            <tbody>${app.state.invoices.slice().reverse().map(inv => `
                                <tr class="border-b border-theme hover:bg-slate-50 dark:hover:bg-slate-800">
                                    <td class="p-4 font-bold text-blue-600">${inv.id}</td>
                                    <td class="p-4 text-xs text-muted">${inv.date}</td>
                                    <td class="p-4 font-medium">${inv.customerName}</td>
                                    <td class="p-4 font-black">${app.formatCurrency(inv.total)}</td>
                                    <td class="p-4 text-xs text-muted">${inv.mode}</td>
                                    <td class="p-4">
                                        <select onchange="app.updateInvoiceStatus('${inv.id}', this.value)" class="bg-transparent border border-theme rounded text-[10px] font-bold p-1 outline-none ${inv.status === 'PAID' ? 'text-green-600' : 'text-orange-500'}">
                                            <option value="PAID" ${inv.status === 'PAID' ? 'selected' : ''}>PAID</option>
                                            <option value="UNPAID" ${inv.status === 'UNPAID' ? 'selected' : ''}>UNPAID</option>
                                            <option value="DRAFT" ${inv.status === 'DRAFT' ? 'selected' : ''}>DRAFT</option>
                                        </select>
                                    </td>
                                    <td class="p-4 text-right space-x-2">
                                        <button onclick="app.viewInvoice('${inv.id}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded" title="View/Print"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                        <button onclick="app.deleteInvoice('${inv.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </td>
                                </tr>`).join('') || '<tr><td colspan="7" class="p-8 text-center text-muted">No invoices found.</td></tr>'}</tbody>
                        </table>
                    </div>
                `;
                lucide.createIcons();
            },

            updateInvoiceStatus: (id, status) => {
                const inv = app.state.invoices.find(i => i.id === id);
                if(inv) {
                    inv.status = status;
                    app.saveToLocal();
                    app.renderInvoiceList();
                    app.toast('Invoice status updated');
                }
            },

            deleteInvoice: (id) => {
                if(confirm('Delete this invoice permanently?')) {
                    app.state.invoices = app.state.invoices.filter(i => i.id !== id);
                    app.saveToLocal();
                    app.renderInvoiceList();
                    app.toast('Invoice deleted');
                }
            },

            viewInvoice: (id) => {
                const inv = app.state.invoices.find(i => i.id === id);
                if(!inv) return;
                
                const type = "INVOICE COPY";
                const cust = app.state.customers.find(c => c.name === inv.customerName) || { name: inv.customerName, address: '...', gstin: '' };
                
                let subtotal = 0, totalGst = 0;
                const rows = inv.items.map((item, i) => {
                    const total = item.qty * item.sellPrice; const gst = total * (item.gst / 100); subtotal += total; totalGst += gst;
                    return `<tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding: 8px 0;">${i+1}</td><td style="padding: 8px 0;"><div style="font-weight: bold;">${item.name}</div><div style="font-size: 8px; color: #64748b;">SKU: ${item.sku}</div></td><td style="padding: 8px 0;">${item.qty}</td><td style="padding: 8px 0; text-align: right;">${item.sellPrice.toFixed(2)}</td><td style="padding: 8px 0; text-align: right;">${total.toFixed(2)}</td></tr>`;
                }).join('');

                const html = `
                    <div class="invoice-container" id="print-copy">
                        <div class="watermark">${inv.status}</div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                            <div><h2 style="font-size: 18px; font-weight: 900; color: #1e293b; margin: 0;">${app.state.company.name}</h2><div style="font-size: 10px; color: #64748b; margin-top: 4px;">${app.state.company.address}<br>GST: ${app.state.company.gst} | PAN: ${app.state.company.pan}</div></div>
                            <div style="text-align: right;"><div style="font-size: 12px; font-weight: 800; color: #2563eb;">${type}</div><div style="font-size: 10px; font-weight: 700;"># ${inv.id}</div><div style="font-size: 9px; color: #64748b;">Date: ${inv.date}</div></div>
                        </div>
                        <div style="display: grid; grid-template-cols: 1fr 1fr; gap: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; margin-bottom: 20px;">
                            <div style="font-size: 10px;"><div style="font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 4px;">Bill To:</div><div style="font-weight: 700; font-size: 12px;">${cust.name}</div><div>${cust.address}</div><div style="font-weight: 700;">GST: ${cust.gstin}</div></div>
                            <div style="font-size: 10px; text-align: right;"><div style="font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 4px;">Bank Info:</div><div style="white-space: pre-line;">${app.state.company.bank}</div></div>
                        </div>
                        <table style="width: 100%; font-size: 10px; border-collapse: collapse; margin-bottom: 20px;"><thead><tr style="text-align: left; color: #64748b; border-bottom: 2px solid #e2e8f0;"><th style="padding: 5px 0;">#</th><th style="padding: 5px 0;">Description</th><th style="padding: 5px 0;">Qty</th><th style="padding: 5px 0; text-align: right;">Rate</th><th style="padding: 5px 0; text-align: right;">Total</th></tr></thead><tbody>${rows}</tbody></table>
                        <div style="display: flex; justify-content: flex-end;"><div style="width: 200px; font-size: 11px;"><div style="display: flex; justify-content: space-between; padding: 4px 0;"><span>Subtotal</span><span>${subtotal.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; padding: 4px 0;"><span>Tax (GST)</span><span>${totalGst.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #000; font-weight: 900; margin-top: 5px; font-size: 14px;"><span>GRAND TOTAL</span><span>${app.formatCurrency(inv.total)}</span></div></div></div>
                        <div style="margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 10px; font-size: 8px; color: #64748b;"><div style="font-weight: 800; margin-bottom: 2px; color: #475569;">Terms & Conditions</div><div style="white-space: pre-line;">${app.state.company.terms}</div><div style="text-align: center; margin-top: 20px; font-weight: 700;">Computer Generated Invoice - No Signature Required</div></div>
                        <div class="no-print mt-4 text-center"><button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Print Invoice</button></div>
                    </div>
                `;
                
                app.showModal('Invoice View', html);
            },

            renderPayments: () => {
                const paidInvoices = app.state.invoices.filter(inv => inv.status === 'PAID');
                const modes = { Cash: 0, UPI: 0, Card: 0, 'Bank Transfer': 0 };
                paidInvoices.forEach(i => modes[i.mode] = (modes[i.mode] || 0) + i.total);
                document.getElementById('view-payments').innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm"><h4 class="font-bold mb-4">Cash Flow Distribution</h4><div class="h-64"><canvas id="paymentChart"></canvas></div></div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-slate-900 rounded-xl p-6 text-white shadow-xl"><h4 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Expense Module</h4><div class="grid grid-cols-3 gap-3"><input type="text" id="exp-reason" placeholder="Reason" class="col-span-1 bg-white/10 p-3 rounded-lg border border-white/10 outline-none text-sm text-white placeholder:text-slate-400"><input type="number" id="exp-amount" placeholder="Amount" class="bg-white/10 p-3 rounded-lg border border-white/10 outline-none text-sm text-white placeholder:text-slate-400"><button onclick="app.recordExpense()" class="bg-blue-600 p-3 rounded-lg font-bold hover:bg-blue-500">Record</button></div></div>
                            <div class="bg-card p-6 rounded-xl border border-theme shadow-sm"><h4 class="font-bold mb-4">Daily Cash Closing</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg"><p class="text-[10px] uppercase font-bold text-muted">Cash Sales</p><p class="text-lg font-black">${app.formatCurrency(paidInvoices.filter(i => i.mode === 'Cash').reduce((a, b) => a + b.total, 0))}</p></div><div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg"><p class="text-[10px] uppercase font-bold text-muted">Total Expenses</p><p class="text-lg font-black text-red-500">${app.formatCurrency(app.state.expenses.reduce((a, b) => a + b.amount, 0))}</p></div></div></div>
                        </div>
                    </div>
                `;
                if(app.charts.payment) app.charts.payment.destroy();
                const ctx = document.getElementById('paymentChart').getContext('2d');
                app.charts.payment = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(modes), datasets: [{ data: Object.values(modes), backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                lucide.createIcons();
            },

            recordExpense: () => {
                const reason = document.getElementById('exp-reason').value;
                const amount = parseFloat(document.getElementById('exp-amount').value);
                if(!reason || !amount) return app.toast('Invalid expense', 'error');
                app.state.expenses.push({ id: Date.now(), reason, amount, date: new Date().toISOString() });
                app.saveToLocal(); app.renderPayments(); app.toast('Expense recorded');
            },

            renderReports: () => {
                document.getElementById('view-reports').innerHTML = `
                    <div class="bg-card p-8 rounded-xl border border-theme flex flex-col md:flex-row justify-between items-center gap-6 shadow-sm">
                        <div><h3 class="text-2xl font-black">Business Analytics</h3><p class="text-muted">Comprehensive sales, tax, and inventory reports.</p></div>
                        <div class="flex gap-3">
                            <button onclick="app.exportData()" class="bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-200 px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700"><i data-lucide="file-json" class="w-4 h-4"></i> Export Data</button>
                            <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-blue-700"><i data-lucide="download" class="w-4 h-4"></i> Download PDF</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="bg-card p-6 rounded-xl border border-theme shadow-sm"><h4 class="font-bold text-muted text-xs uppercase mb-4">Aging Receivables</h4><div class="space-y-4"><div class="flex justify-between items-center text-sm"><span class="font-medium text-muted">30 Days Overdue</span><span class="font-bold text-orange-500">${app.formatCurrency(0)}</span></div></div></div>
                    </div>
                `;
                lucide.createIcons();
            },

            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.state));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "bif_backup_" + new Date().toISOString().split('T')[0] + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                app.toast('Data exported successfully');
            },

            renderHardware: () => {
                document.getElementById('view-hardware').innerHTML = `
                    <div class="max-w-3xl mx-auto bg-card rounded-xl border border-theme p-8 space-y-8 shadow-sm">
                        <h3 class="text-2xl font-black">Hardware Integration</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 bg-slate-50 dark:bg-slate-800 rounded-xl border border-dashed border-theme flex flex-col items-center text-center"><i data-lucide="barcode" class="w-12 h-12 text-muted mb-4"></i><h4 class="font-bold">Barcode Scanner</h4><p class="text-xs text-muted mb-4">USB/Bluetooth scanner support active.</p><span class="px-3 py-1 bg-green-100 text-green-700 text-[10px] font-black rounded-full uppercase">Connected</span></div>
                            <div class="p-6 bg-slate-50 dark:bg-slate-800 rounded-xl border border-dashed border-theme flex flex-col items-center text-center"><i data-lucide="printer" class="w-12 h-12 text-muted mb-4"></i><h4 class="font-bold">Thermal Printer</h4><p class="text-xs text-muted mb-4">80mm / 58mm POS printer integration available.</p><button onclick="window.print()" class="px-3 py-1 bg-blue-100 text-blue-700 text-[10px] font-black rounded-full uppercase hover:bg-blue-200">Test Page</button></div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            renderSecurity: () => {
                document.getElementById('view-security').innerHTML = `
                    <div class="max-w-3xl mx-auto bg-card rounded-xl border border-theme p-8 space-y-8 shadow-sm">
                        <h3 class="text-2xl font-black">Security & Stack</h3>
                        <div class="space-y-4">
                            <div class="p-4 border-l-4 border-blue-600 bg-blue-50 dark:bg-blue-900/20"><h4 class="font-bold text-blue-800 dark:text-blue-300">Technology Stack</h4><p class="text-sm text-blue-600 dark:text-blue-400">Frontend: Vanilla JS, Tailwind CSS. | Database: LocalStorage.</p></div>
                            <div class="p-4 border-l-4 border-green-600 bg-green-50 dark:bg-green-900/20"><h4 class="font-bold text-green-800 dark:text-green-300">Compliance</h4><p class="text-sm text-green-600 dark:text-green-400">GST Ready. Data privacy ensured via local-first storage.</p></div>
                        </div>
                    </div>
                `;
            },

            showModal: (title, content) => { document.getElementById('modal-title').innerText = title; document.getElementById('modal-body').innerHTML = content; document.getElementById('modal-overlay').classList.remove('hidden'); },
            closeModal: () => { document.getElementById('modal-overlay').classList.add('hidden'); },
            updateCurrency: () => { app.state.company.currency = document.getElementById('currency-selector').value; app.saveToLocal(); app.navigate('dashboard'); }
        };

        window.onload = app.init;
    </script>
</body>
</html>
